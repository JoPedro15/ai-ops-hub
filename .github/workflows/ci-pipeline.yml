# Path: .github/workflows/ci-pipeline.yml

name: CI Quality Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: { }

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  OUTPUT_FOLDER_ID: ${{ vars.OUTPUT_FOLDER_ID }}
  GDRIVE_DATA_RAW_FOLDER_ID: ${{ vars.GDRIVE_DATA_RAW_FOLDER_ID }}
  GDRIVE_DATA_PROCESSED_FOLDER_ID: ${{ vars.GDRIVE_DATA_PROCESSED_FOLDER_ID }}
  CAR_DATA_FILE_ID: ${{ vars.CAR_DATA_FILE_ID }}
  GDRIVE_MODELS_FOLDER_ID: ${{ vars.GDRIVE_MODELS_FOLDER_ID }}
  GDRIVE_MODELS_DEV_FOLDER_ID: ${{ vars.GDRIVE_MODELS_DEV_FOLDER_ID }}
  GDRIVE_MODELS_PROD_FOLDER_ID: ${{ vars.GDRIVE_MODELS_PROD_FOLDER_ID }}
  GDRIVE_REPORTS_FOLDER_ID: ${{ vars.GDRIVE_REPORTS_FOLDER_ID }}
  PYTHONPATH: ${{ github.workspace }}

jobs:
  # --- JOB 1: Static Analysis, Quality Gate & Security ---
  quality-gate:
    name: Quality & Security Gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Mock Credentials for Static Analysis
        run: |
          mkdir -p infra/credentials/gdrive
          echo '{}' > infra/credentials/gdrive/credentials.json
          echo '{}' > infra/credentials/gdrive/token.json

      - name: Environment Setup
        run: make setup CI=true

      - name: Run Linting, Formatting, and Pre-commit Hooks
        run: |
          make lint-and-format
          make -C . pre-commit

      - name: Run Security Audit
        run: make security

  # --- JOB 2: Component Tests (Unit & Integration) ---
  component-tests:
    name: Component Tests (${{ matrix.component }})
    needs: quality-gate
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        component: [gdrive, ingestor, processor, visualizer]
        include:
          - component: gdrive
            path: infra/gdrive/tests
            health_check: true
          - component: ingestor
            path: infra/ai_utils/tests/test_ingestor.py
            health_check: true
          - component: processor
            path: infra/ai_utils/tests/test_processor.py
            health_check: true
          - component: visualizer
            path: infra/ai_utils/tests/test_visualizer.py
            health_check: false # No specific health check for visualizer

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Deploy Credentials
        env:
          CREDS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
          TOKEN_JSON: ${{ secrets.GOOGLE_TOKEN_JSON }}
        run: |
          mkdir -p infra/credentials/gdrive
          if [ "${{ matrix.component }}" == "gdrive" ]; then
            echo "Deploying REAL secrets for GDrive integration tests..."
            echo "$CREDS_JSON" > infra/credentials/gdrive/credentials.json
            echo "$TOKEN_JSON" > infra/credentials/gdrive/token.json
          else
            echo "Deploying MOCK secrets for unit tests..."
            echo '{}' > infra/credentials/gdrive/credentials.json
            echo '{}' > infra/credentials/gdrive/token.json
          fi

      - name: Install Environment
        run: make setup CI=true

      - name: Run Component Health Check
        if: ${{ matrix.health_check == true }}
        run: python3 -m infra.scripts.health_check.health_check_${{ matrix.component }}

      - name: Run Component Tests
        run: pytest ${{ matrix.path }} --verbose

  # --- JOB 3: Final System Health Check ---
  system-health:
    name: Full System Health Check
    needs: component-tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Deploy Production Credentials
        env:
          CREDS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
          TOKEN_JSON: ${{ secrets.GOOGLE_TOKEN_JSON }}
        run: |
          mkdir -p infra/credentials/gdrive
          echo "$CREDS_JSON" > infra/credentials/gdrive/credentials.json
          echo "$TOKEN_JSON" > infra/credentials/gdrive/token.json

      - name: Install Environment
        run: make setup CI=true

      - name: Run Full Health Suite
        run: make health-check
