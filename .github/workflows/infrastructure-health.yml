# Path: .github/workflows/infrastructure-health.yml

name: Infrastructure Health Check

on:
  schedule:
    - cron: '0 20 * * 5' # Weekly on Fridays at 20:00
  workflow_dispatch:

permissions:
  contents: read

env:
  OUTPUT_FOLDER_ID: ${{ vars.OUTPUT_FOLDER_ID }}
  GDRIVE_DATA_RAW_FOLDER_ID: ${{ vars.GDRIVE_DATA_RAW_FOLDER_ID }}
  GDRIVE_DATA_PROCESSED_FOLDER_ID: ${{ vars.GDRIVE_DATA_PROCESSED_FOLDER_ID }}
  CAR_DATA_FILE_ID: ${{ vars.CAR_DATA_FILE_ID }}
  GDRIVE_MODELS_FOLDER_ID: ${{ vars.GDRIVE_MODELS_FOLDER_ID }}
  GDRIVE_MODELS_DEV_FOLDER_ID: ${{ vars.GDRIVE_MODELS_DEV_FOLDER_ID }}
  GDRIVE_MODELS_PROD_FOLDER_ID: ${{ vars.GDRIVE_MODELS_PROD_FOLDER_ID }}
  GDRIVE_REPORTS_FOLDER_ID: ${{ vars.GDRIVE_REPORTS_FOLDER_ID }}
  PYTHONPATH: ${{ github.workspace }}

jobs:
  health-audit:
    name: Weekly System Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Deploy Production Credentials
        env:
          CREDS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
          TOKEN_JSON: ${{ secrets.GOOGLE_TOKEN_JSON }}
        run: |
          mkdir -p infra/credentials/gdrive
          echo "$CREDS_JSON" > infra/credentials/gdrive/credentials.json
          echo "$TOKEN_JSON" > infra/credentials/gdrive/token.json
          echo "âœ… Production Secrets deployed."

      - name: Install Environment
        run: make setup CI=true

      - name: Run Full Health Suite
        # Validates GDrive connectivity, permissions, and module integrity
        run: make health-check

      - name: Run Integration Tests
        # Validates functional logic and deep API integration
        run: make test-all
