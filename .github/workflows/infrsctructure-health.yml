# Path: .github/workflows/infrsctructure-health.yml

name: Infrastructure Health Check

on:
  schedule:
    - cron: '0 20 * * 5'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  quality-check:
    name: Global Quality & Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Initialize Data Structure
        run: |
          mkdir -p data/raw
          mkdir -p data/processed
          mkdir -p data/logs

      - name: Deploy Credentials for Integrity Check
        env:
          CREDS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
          TOKEN_JSON: ${{ secrets.GOOGLE_TOKEN_JSON }}
        run: |
          mkdir -p infra/credentials/gdrive
          python3 -c "import os; open('infra/credentials/gdrive/credentials.json', 'w').write(os.environ['CREDS_JSON'])"
          python3 -c "import os; open('infra/credentials/gdrive/token.json', 'w').write(os.environ['TOKEN_JSON'])"

      - name: Environment Setup
        env:
          OUTPUT_FOLDER_ID: ${{ vars.OUTPUT_FOLDER_ID }}
          GDRIVE_DATA_RAW_ID: ${{ vars.GDRIVE_DATA_RAW_FOLDER_ID }}
          GDRIVE_DATA_PROC_ID: ${{ vars.GDRIVE_DATA_PROCESSED_FOLDER_ID }}
          CAR_DATA_FILE_ID: ${{ vars.CAR_DATA_FILE_ID }}
        run: make setup CI=true

      - name: Lint & Static Analysis
        run: make lint-and-format

      - name: Security SAST
        run: make security

      - name: Infrastructure Integrity
        run: make verify-env

  system-audit:
    name: Full System Stability Audit
    needs: quality-check
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
      OUTPUT_FOLDER_ID: ${{ secrets.OUTPUT_FOLDER_ID }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install Environment
        run: make setup CI=true

      - name: Deploy Production Secrets
        env:
          CREDS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
          TOKEN_JSON: ${{ secrets.GOOGLE_TOKEN_JSON }}
        run: |
          # 1. Modular Infrastructure Prep
          mkdir -p infra/credentials/gdrive
          mkdir -p data/logs

          # 2. Secure Secret Injection
          python3 -c "import os; open('infra/credentials/gdrive/credentials.json', 'w').write(os.environ['CREDS_JSON'])"
          python3 -c "import os; open('infra/credentials/gdrive/token.json', 'w').write(os.environ['TOKEN_JSON'])"

          # 3. Pre-flight Integrity Check
          python3 -c "import json; json.load(open('infra/credentials/gdrive/credentials.json')); json.load(open('infra/credentials/gdrive/token.json'))"
          echo "âœ… Production Secrets deployed in modular vault."

      - name: Run Health Checks
        run:
          make health-check CI=true

      - name: Run Tests
        run:
          make test-all

      - name: Upload Health Logs
        if: always() # Ensures logs are uploaded even if tests fail
        uses: actions/upload-artifact@v4
        with:
          name: infrastructure-logs
          path: data/logs/*.log
          retention-days: 7
