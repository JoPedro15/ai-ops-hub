name: Infrastructure Health Check

on:
  schedule:
    - cron: '0 20 * * 5'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  quality-check:
    name: Linting, Formatting & Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install Dependencies
        # Ensuring all libs are present for static analysis
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff pip-audit

      - name: Ruff Quality Gate
        run: |
          ruff check .
          ruff format . --check
          ruff check . --select S

      - name: Dependency Security Audit
        run: make security CI=true

  global-health-check:
    name: Automated Integration Health
    needs: quality-check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Initialize & Install Dependencies
        # Critical step: Full environment replication for integration test
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          make setup CI=true

      - name: Execute Health Diagnostics
        env:
          GDRIVE_CREDENTIALS_DATA: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
          GDRIVE_TOKEN_DATA: ${{ secrets.GOOGLE_TOKEN_JSON }}
          GDRIVE_CREDENTIALS_PATH: "data/credentials.json"
          GDRIVE_TOKEN_PATH: "data/token.json"
          PYTHONPATH: ${{ github.workspace }}
        run: |
          mkdir -p data/logs
          printf "%s" "$GDRIVE_CREDENTIALS_DATA" > "$GDRIVE_CREDENTIALS_PATH"
          printf "%s" "$GDRIVE_TOKEN_DATA" > "$GDRIVE_TOKEN_PATH"

          # Pre-flight Check
          python3 -c "import json; [json.load(open(f)) for f in ['$GDRIVE_CREDENTIALS_PATH', '$GDRIVE_TOKEN_PATH']]"

          make health-check CI=true

      - name: Upload Health Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: infrastructure-logs
          path: data/logs/*.log
          retention-days: 7
